---
title: 'ドメインサービス (Domain Service)'
---

# ドメインサービスとは

ドメインサービス (Domain Service) とは、ドメインモデルの中で、**エンティティや値オブジェクトだけでは自然に表現できない**ビジネスロジックをカプセル化するための「**サービス**」です。

## サービスとは

ここで、「サービス」について考えておきましょう。DDD ではサービスが 2 つ存在します。1 つが本章で紹介する**ドメインサービス**で、もう一方が**アプリケーションサービス**です。混同しがちですが、それぞれ以下のような違いがあります。
| | ドメインサービス | アプリケーションサービス |
|-----------------------|-------------------------------------|---------------------------------------|
| **主な役割** | ビジネスロジックの実装 | ユースケースの実装 |
| **操作するもの** | ドメインオブジェクト (集約) | ドメインサービス、ドメインオブジェクト (集約) |
| **ビジネスルール** | ドメイン固有のルールを実装 | ユースケース固有の手順を調整 |
| **データの永続化** | 永続化責務は持たない | 永続化の責務を持つ |

ドメインサービスはアプリケーションサービスと比較して、ドメインに特化したサービスです。

## 不自然なドメインの振る舞い

エンティティや値オブジェクトだけでは自然に表現できないビジネスロジックとは何でしょうか？
たとえば、書籍エンティティの識別子 (ID) は 「ISBN」 であるというルールがありました。ISBN は書籍固有のコードで、異なる書籍間で重複することはありません。つまり、同一 ISBN で書籍を複数登録することはできません。これはビジネスルールであり、このルール守るために書籍を登録する際には、すでに登録されている ISBN かどうかドメインオブジェクトで確認する必要があります。

それでは、このルールを書籍エンティティに実装してみましょう。

```js:StockManagement/Domain/models/Book/Book.ts
export class Book {
  (省略)

  isDuplicateISBN(isbn: BookId) {
    // 既に登録されている ISBN かどうかを確認する処理
  }
}
```

次に実際にこのメソッドを利用して重複チェックを行ってみます。

```js
const bookId = new BookId('9784167158057');
const title = new Title('吾輩は猫である');
const price = new Price({
  amount: 770,
  currency: 'JPY',
});

const book = Book.create(bookId, title, price);
// 書籍自身がISBNの重複チェックを行う
const isDuplicateISBN = book.isDuplicateISBN(bookId);
```

書籍自身が ISBN の重複チェックを行っていますが、自身の一意性 (重複のないこと) を自身でチェックすることは、ドメインモデルの観点から見ると不自然です。通常、エンティティの一意性は外部のコンテキスト（たとえば、データベースやリポジトリ）によって管理されるべきです。エンティティ自身が自分の一意性を管理することは、役割と責任の観点から見ても不自然です。

# 書籍重複チェックドメインサービスの実装

このような不自然さを解消するために、ドメインサービスを利用します。
それでは`Domain`ディレクトリ配下に`services/Book/ISBNDuplicationCheckDomainService/`ディレクトリを作成します。次に`ISBNDuplicationCheckDomainService.ts`というファイル作成し、ISBN の重複チェックを行う処理を移動してみましょう。

```js:.../Domain/services/Book/ISBNDuplicationCheckDomainService/ISBNDuplicationCheckDomainService.ts
import { BookId } from 'Domain/models/Book/BookId/BookId';

export class ISBNDuplicationCheckDomainService {
  async execute(isbn: BookId): Promise<boolean> {
    // 本来は、データベースに問い合わせて重複があるか確認する。この章では省略。
    const isDuplicateISBN = false;

    return isDuplicateISBN;
  }
}
```

本来はリポジトリを利用し、データベースに問い合わせて重複があるか確認する処理を実装しますが、ここでは簡略化のために単純に結果 (false) のみを返す実装にしています。 次章 (`chapter12 リポジトリ`) リポジトリを利用した実装に変更します。

:::message
ドメインサービスの命名は、そのドメインで表現したい概念に基づいて行います。ここでは ISBN の重複チェックを行うドメインサービスなので、`ISBNDuplicationCheckDomainService`という名前にしました。アプリケーションサービスと混同させないために、ドメインサービスの命名規則は`[処理名]DomainService`とするのがオススメです。
:::

それでは重複のチェックにこのドメインサービスを利用するように変更します。

```js
const bookId = new BookId('9784167158057');
const title = new Title('吾輩は猫である');
const price = new Price({
  amount: 770,
  currency: 'JPY',
});

const book = Book.create(bookId, title, price);
const isDuplicateISBN = await ISBNDuplicationCheckDomainService.execute(bookId);
```

`ISBNDuplicationCheckDomainService` を利用することで、書籍自身に重複かどうか問い合わせをしていた不自然さを解消することができました。このように、エンティティや値オブジェクトだけでは自然に表現できないロジックはドメインサービスに実装することで、ドメインモデルをより自然な形で表現することができます。

## ドメインモデル貧血症

ドメインサービスを利用することで柔軟にドメインモデルを表現することができますが、ドメインサービスを過剰に利用すると**ドメインモデル貧血症**になってしまう可能性があります。ドメインモデル貧血症とは、ドメインモデルがドメインサービスに依存しすぎてしまい、ドメインモデル自身が何も語らなくなってしまう状態を指します。

たとえば、エンティティには属性を変更するメソッドがあります。これはドメインサービスを利用することでも実現できます。

```js
// ドメインサービスを利用する前の例
class Book {
  constructor(
    private readonly id: BookId,
    private title: Title,
  ) {}

  changeTitle(title: Title) {
    // タイトル変更時のバリデーション
    this.title = title;
  }
}

// ドメインサービスを利用した例
class Book {
  constructor(
    private readonly id: BookId,
    public title: Title,
  ) {}
}

class BookTitleChangeDomainService {
  constructor(book: Book){}

  execute(newTitle: Title) {
    // タイトル変更時のバリデーション
    this.book.title = newTitle;
  }
}
```

しかし、ドメインサービスを利用した例の `Book` エンティティを見てみると、ただのデータ保持しただけのクラスで、どのようなビジネスルールがあるのか読み取れなくなってしまいました。
ドメインの表現は、ドメインモデル貧血症にならないように、**まずはエンティティや値オブジェクトで実装できないか検討**し、それでも表現できない場合にのみドメインサービスを利用するようにしましょう。

## ドメインサービスを利用する基準

> エンティティや値オブジェクトだけでは自然に表現できない

ドメインサービスを利用する基準を上記のように定義しましたが、より具体的にはどのような場合にドメインサービスを利用するのが適切なのでしょうか？具体例としては、以下のような場合です。

- 複数集約をまたいだ処理が必要な場合
- DB ヘの問い合わせが必要な場合

それぞれ説明します。

### 複数集約をまたいだ処理が必要な場合

ドメインモデル内の複数の集約間でビジネスロジックを実行する必要がある場合、ドメインサービスを利用します。各集約はそれ自体で一貫性を持ちますが、複数の集約間で一貫性を保つための操作は、それぞれの集約の範囲を超えるため、集約の外部で行われるべきです。

たとえば、書籍販売コンテキストの「書籍」と「レビュー」が別集約かつ `1対n`の関係性でレビュー数に上限がある場合、書籍の登録時にレビュー数が上限に達していないかを確認する必要があります。このような場合、書籍の集約内でレビュー数を管理するのではなく、ドメインサービスを利用してレビュー数を取得し、上限に達していないかを確認するようにします。

### DB ヘの問い合わせが必要な場合

エンティティや値オブジェクトでは表現できない、データベースへの問い合わせが必要なビジネスロジックもドメインサービスで実装されます。エンティティや値オブジェクトは、通常、自身の状態を保持し、その状態に基づいてビジネスロジックを実行します。

しかし、データベースからのデータ取得や集計など、外部リソースに依存する操作は、エンティティや値オブジェクトの範囲を超えるため、ドメインサービスを通じて行われるべきです。たとえば、重複チェックなどはその典型的な例です。

# まとめ

- ドメインサービスとアプリケーションサービスは似ているが、それぞれ別の役割を持つ
- エンティティや値オブジェクトだけでは自然に表現できないビジネスロジックはドメインサービスに実装する
- ドメインモデル貧血症にならないように、まずはドメインオブジェクトで実装できないか検討する

本章では、ドメインサービスについて学びました。ドメインサービスはドメインモデルの設計を単純化するために利用されます。ドメインモデルの設計において、ドメインサービスを利用するかどうかは、ドメインモデルの表現を自然にするために重要です。
次章は、ポジトリについて学び、`ISBNDuplicationCheckDomainService`にリポジトリを適用します。

### これまでのコード

https://github.com/yamachan0625/ddd-hands-on/tree/domain-service
